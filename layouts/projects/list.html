{{ define "main" }}
<section class="section">
  {{ if not .IsHome }}
    <h1>{{ .Title }}</h1>
  {{ end }}
  {{ with .Content }}<div class="content">{{ . }}</div>{{ end }}

  <!-- Filters: Search + Tag selection -->
  <div id="project-filters" class="filters bg-card border border-border rounded-lg p-6 mb-8" role="group" aria-labelledby="filters-heading" aria-controls="projectCards resultsInfo">
    <h2 id="filters-heading" class="visually-hidden">프로젝트 필터</h2>
    <div class="flex flex-col md:flex-row gap-4 items-start md:items-center">
      <div class="flex-1 min-w-0">
        <input id="searchInput" type="search" placeholder="프로젝트 검색 (제목/요약)" class="w-full" aria-label="프로젝트 검색" inputmode="search" autocomplete="off" />
      </div>
      <div id="tagFilters" class="tags flex-1" role="group" aria-label="태그 필터"></div>
      <button id="clearFilters" class="btn btn-secondary" type="button" aria-label="필터 초기화">필터 초기화</button>
    </div>
    <p id="resultsInfo" class="meta mt-4" aria-live="polite" role="status"></p>
  </div>

  <div class="cards" id="projectCards" role="list">
    {{ range .Paginator.Pages }}
      <article class="card" role="listitem" data-title="{{ .Title | plainify | lower }}" data-summary="{{ (cond (ne .Params.summary "") .Params.summary .Summary) | plainify | lower }}" data-tags="{{ delimit .Params.techTags "," | lower }}">
        {{ $thumb := .Params.thumbnail }}
        {{ $needsDynamic := or (not $thumb) (eq $thumb "/images/og-default.svg") }}
        <a href="{{ .RelPermalink }}">
          {{ if $needsDynamic }}
            {{ $key := md5 .Permalink }}
            {{ $tpl := resources.Get "images/project-thumb-template.svg" | resources.ExecuteAsTemplate (printf "gen/thumbs/%s.svg" $key) . }}
            <img class="thumb" src="{{ $tpl.Permalink }}" alt="{{ .Title }} thumbnail" loading="lazy" decoding="async" width="640" height="360" sizes="(max-width: 700px) 100vw, 640px" />
          {{ else }}
            {{/* Try responsive pipeline if an assets/ counterpart exists and is not SVG */}}
            {{ $ext := path.Ext $thumb }}
            {{ $isSVG := eq (lower $ext) ".svg" }}
            {{ $assetsPath := printf "assets%s" $thumb }}
            {{ if and (not $isSVG) (fileExists $assetsPath) }}
              {{ $res := resources.Get (printf "%s" (replace $thumb "/" "/")) }}
              {{ if $res }}
                {{ $img640 := $res | images.Fit "640x360" }}
                {{ $img960 := $res | images.Fit "960x540" }}
                {{ $img1200 := $res | images.Fit "1200x675" }}
                <img class="thumb"
                     src="{{ $img640.RelPermalink }}"
                     srcset="{{ $img640.RelPermalink }} 640w, {{ $img960.RelPermalink }} 960w, {{ $img1200.RelPermalink }} 1200w"
                     sizes="(max-width: 700px) 100vw, 640px"
                     width="640" height="360"
                     alt="{{ .Title }} thumbnail"
                     loading="lazy" decoding="async" />
              {{ else }}
                <img class="thumb" src="{{ $thumb | relURL }}" alt="{{ .Title }} thumbnail" loading="lazy" decoding="async" width="640" height="360" sizes="(max-width: 700px) 100vw, 640px" />
              {{ end }}
            {{ else }}
              <img class="thumb" src="{{ $thumb | relURL }}" alt="{{ .Title }} thumbnail" loading="lazy" decoding="async" width="640" height="360" sizes="(max-width: 700px) 100vw, 640px" />
            {{ end }}
          {{ end }}
        </a>
        <h2><a href="{{ .RelPermalink }}">{{ .Title }}</a></h2>
        {{ with .Date }}<p class="meta">{{ .Format "2006-01-02" }}</p>{{ end }}
        {{ with .Params.summary }}<p class="summary-text">{{ . }}</p>{{ else }}{{ if .Summary }}<p class="summary-text">{{ .Summary }}</p>{{ end }}{{ end }}

        {{ with .Params.repo }}
          {{ $repoURL := . }}
          {{ $repoPath := replace $repoURL "https://github.com/" "" }}
          <div class="meta" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <img class="badge" alt="GitHub stars" src="https://img.shields.io/github/stars/{{ $repoPath }}?style=social" loading="lazy" decoding="async">
            <img class="badge" alt="Top language" src="https://img.shields.io/github/languages/top/{{ $repoPath }}" loading="lazy" decoding="async">
          </div>
        {{ end }}
        {{ with .Params.techTags }}
          <ul class="tags">
            {{ range . }}<li class="tag-pill">{{ . }}</li>{{ end }}
          </ul>
        {{ end }}
        <div class="mt-4">
          <a class="btn btn-primary" href="{{ .RelPermalink }}" aria-label="프로젝트 {{ .Title }} 자세히 보기">
            자세히 보기
            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </a>
        </div>
      </article>
    {{ end }}
  </div>

  <nav class="pagination">
    {{ template "_internal/pagination.html" . }}
  </nav>
</section>
<script src="{{ "js/projects-list.js" | relURL }}" defer></script>
{{ end }}
